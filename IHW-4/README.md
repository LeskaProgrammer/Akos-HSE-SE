# Индивидуальное домашнее задание №4

**Студент:** Симонов Алексей Дмитриевич
**Группа:** 248
**Вариант:** 22 (Задача о картинной галерее)

## 1. Условие задачи

**Задача о картинной галерее.** Вахтер следит за тем, чтобы в картинной галерее одновременно было не более 25 посетителей. Для обозрения представлены 5 картин. Каждый посетитель случайно переходит от картины к картине, но если на желаемую картину любуются более пяти посетителей, он стоит в стороне и ждет, пока число желающих увидеть эту картину не станет меньше. Посетитель покидает галерею по завершении осмотра всех картин. Каждый посетитель уникальный, то есть имеет свой номер (например, PID). В галерею также пытаются постоянно зайти новые посетители, которые ожидают своей очереди и разрешения от вахтера, если та заполнена.

Создать многопоточное приложение, моделирующее однодневную работу картинной галереи.

## 2. Сценарий поведения (Модель)

В программе моделируется работа галереи с использованием многопоточности.

* **Сущности:**
    * **Вахтер (Watchman):** Управляющий поток/логика, ограничивающая вход (максимум 25 человек).
    * **Посетители (Visitors):** `N` потоков. Каждый имеет уникальный ID.
    * **Картины:** 5 ресурсов, у каждого лимит — 5 зрителей.

* **Алгоритм жизни Посетителя:**
    1.  Приход к галерее (случайная задержка).
    2.  Попытка войти. Если внутри 25 человек — ожидание.
    3.  Вход.
    4.  Генерация случайного маршрута по 5 картинам.
    5.  Просмотр картин по очереди:
        * Попытка подойти (если у картины < 5 человек).
        * Просмотр (имитация времени).
        * Уход от картины (освобождение места).
    6.  Выход из галереи (освобождение места для ожидающих на входе).

## 3. Реализация 1: Семафоры (оценка 8 баллов)

**Файл:** `gallery_sem.c`

### Используемые средства
Использованы **семафоры POSIX** (`sem_t`) и мьютексы:

1.  **Вход в галерею:** Семафор `gallery_sem` инициализирован значением 25. `sem_wait` при входе, `sem_post` при выходе.
2.  **Картины:** Массив семафоров `painting_sems[5]`. Каждый инициализирован значением 5.
3.  **Логирование:** Мьютекс `log_mutex` для корректной записи в консоль и файл без "каши" из строк.

### Аргументы командной строки
Программа поддерживает ключи:
* `-n <число>`: Задать число посетителей.
* `-f <файл>`: Взять число посетителей из конфига.
* `-o <файл>`: Записать вывод в файл.

## 4. Реализация 2: Условные переменные (оценка 10 баллов)

**Файл:** `gallery_cond.c`

### Используемые средства
Реализован **Монитор** через мьютекс и условные переменные (`pthread_cond_t`):

1.  **Структура данных:** Хранит текущее количество людей в галерее и у каждой картины.
2.  **Логика:**
    * Поток захватывает мьютекс.
    * Проверяет условие (например, `count < 25`).
    * Если места нет — `pthread_cond_wait`.
    * Если место есть — меняет счетчик, делает свои дела, затем `pthread_cond_signal`.

### Сравнительный анализ
* **Сложность кода:** Решение на семафорах (`gallery_sem.c`) получилось более компактным и читаемым. Семафор по своей природе является счетчиком ресурсов, что идеально ложится на условие задачи ("не более N человек"). Реализация через монитор (Cond Vars) потребовала большего количества шаблонного кода (ручное управление счетчиками, циклы `while` для проверки предикатов, явный захват мьютекса), что увеличивает вероятность ошибки программиста.
* **Производительность:** В рамках данной задачи, где используются искусственные задержки (`usleep`), скорость работы идентична. Однако теоретически семафоры могут быть немного эффективнее для простых задач ограничения доступа, так как монитор требует обязательного захвата мьютекса при любой проверке состояния, создавая чуть большую конкуренцию (contention) между потоками при высокой нагрузке.
* **Поведение:** С точки зрения наблюдателя программы ведут себя абсолютно одинаково. Обе реализации гарантируют соблюдение лимитов (25 в галерее, 5 у картины), отсутствие гонок данных (data races) и отсутствие взаимных блокировок (deadlocks).

## 5. Результаты работы

Программы протестированы на ОС Linux (Ubuntu).

**Компиляция:**

    gcc gallery_sem.c -o gallery_sem -lpthread
    gcc gallery_cond.c -o gallery_cond -lpthread

**Запуск (Семафоры):**

    ./gallery_sem -n 50 -o result.txt

**Фрагмент вывода (`result.txt`):**

    === ЗАПУСК СИМУЛЯЦИИ (СЕМАФОРЫ) ===
    Посетителей: 50
    [ВАХТЕР]: Заступил на смену. Лимит: 25 человек.
    Посетитель 4: Пришел к галерее.
    Посетитель 4: --> ВОШЕЛ в галерею.
    ...
    Посетитель 21: Смотрит картину №1.
    ...
    Посетитель 38: <-- ВЫШЕЛ из галереи.
    === ГАЛЕРЕЯ ЗАКРЫТА ===

**Запуск (Условные переменные):**

    ./gallery_cond -f config.txt -o result_cond.txt

**Фрагмент вывода (`result_cond.txt`):**

    === ЗАПУСК СИМУЛЯЦИИ (COND VARS) ===
    Посетителей: 50
    [ВАХТЕР]: Наблюдение запущено.
    Посетитель 18: --> ВОШЕЛ (Внутри: 1)
    Посетитель 18: Смотрит картину 1
    ...
    Посетитель 37: <-- ВЫШЕЛ (Внутри: 0)
    === КОНЕЦ СИМУЛЯЦИИ ===

## 6. Критерии оценки

### На 4-5 баллов:
- [✓] Сценарий описан.
- [✓] Используются потоки POSIX.
- [✓] Используются разрешенные примитивы.
- [✓] Корректный вывод и завершение.

### На 6-7 баллов:
- [✓] Ввод параметров через командную строку.
- [✓] Генерация случайных данных.

### На 8 баллов:
- [✓] Ввод данных из файла.
- [✓] Вывод результатов в файл.
- [✓] Поддержка конфигурации через CLI.

### На 9-10 баллов:
- [✓] Реализован альтернативный вариант (условные переменные).
- [✓] Проведен сравнительный анализ.