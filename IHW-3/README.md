# IHW_3 — Симуляция картинной галереи (Вариант 22)

**Исполнитель:** Симонов Алексей Дмитриевич  
**Группа:** БПИ248
**Вариант:** 22

---

## Условие задачи
[cite_start]Вахтер следит за тем, чтобы в картинной галерее одновременно было не более 25 посетителей[cite: 229]. [cite_start]Для обозрения представлены 5 картин[cite: 230]. [cite_start]Каждый посетитель случайно переходит от картины к картине, но если на желаемую картину любуются более пяти посетителей, он стоит в стороне и ждет[cite: 230]. [cite_start]Посетитель покидает галерею по завершении осмотра всех картин[cite: 231]. [cite_start]В галерею также пытаются постоянно зайти новые посетители, которые ожидают своей очереди и разрешения от вахтера, если та заполнена[cite: 232].

## Сценарий моделирования
Для решения задачи разработано многопроцессное приложение, где каждая сущность представлена отдельным процессом:
1.  **Галерея (Ресурсы):** Представлена набором семафоров. Входная дверь ограничивается семафором на 25 слотов. Каждая из 5 картин ограничивается семафором на 5 слотов.
2.  **Посетитель (`gallery_visitor`):** Активный процесс. При запуске пытается захватить семафор "вход". Внутри цикла случайно выбирает картины, захватывает семафор конкретной картины, "смотрит" (sleep) и освобождает семафор. После просмотра всех картин освобождает вход и завершается.
3.  **Охранник (`gallery_guard`):** Процесс-наблюдатель логики. Периодически считывает состояние разделяемой памяти и выводит сводку. Принимает решение о закрытии галереи, когда все посетители завершили осмотр.
4.  **Монитор (`gallery_monitor`):** Дополнительный независимый процесс, который подключается к разделяемой памяти и выводит полную историю событий в реальном времени.

## Состав репозитория

- `gallery_common.h` — общие структуры, константы, имена семафоров и разделяемой памяти.
- `gallery_init.c` — настройка IPC: создание разделяемой памяти (shm), инициализация именованных семафоров.
- `gallery_guard.c` — процесс охранника (логирование статуса).
- `gallery_monitor.c` — процесс монитора (вывод событий).
- `gallery_visitor.c` — процесс посетителя (основная логика симуляции).

## Сборка и запуск

Из каталога `IHW_3`:

    make         # сборка и автоматический запуск сценария

Команда `make` выполняет:
1. Компиляцию всех модулей.
2. Запуск инициализатора (`./gallery_init 30`).
3. Запуск охранника и 30 независимых процессов-посетителей в фоне.
4. Запуск монитора для отображения итогов.

### Пример запуска (фрагмент отчёта)

    lesha@DESKTOP-UVM8PF1:/mnt/c/Users/lesha/Desktop/IHW_3$ make
    ./gallery_init 30
    ./gallery_guard &
    for i in $(seq 1 30); do ./gallery_visitor $i & done
    ./gallery_monitor
    Инициализация завершена: ожидается 30 посетителей.
    [1]  450
    [2]  452
    ...
    [VISITOR 27] вышел из галереи. Внутри 0, завершило 30 из 30
    [MONITOR 482] [VISITOR 27] вышел из галереи. Внутри 0, завершило 30 из 30
    [GUARD 0] контроль: внутри 0, завершило 30 из 30
    [GUARD 0] картина 0: возле нее 0 посетителей
    [GUARD 0] картина 1: возле нее 0 посетителей
    [GUARD 0] день окончен, галерея закрывается
    [MONITOR 482] [GUARD 0] день окончен, галерея закрывается
    [1]   Done                    ./gallery_guard
    ...
    lesha@DESKTOP-UVM8PF1:~$

## Технические детали реализации (IPC)
В соответствии с требованиями ОС Linux и стандарта POSIX использованы:
* **POSIX Named Semaphores (`sem_open`):** Для синхронизации доступа к галерее и картинам, а также для защиты записи в лог (мьютекс). [cite_start]Именованные семафоры позволяют взаимодействовать абсолютно независимым процессам[cite: 414].
* [cite_start]**POSIX Shared Memory (`shm_open`, `mmap`):** Для хранения счетчиков (посетители внутри, завершившие, около картин) и кольцевого буфера логов[cite: 415].

---

## Предполагаемая оценка: 10 баллов

Решение удовлетворяет критериям на оценку 10 согласно заданию:

1.  **Базовая реализация (4-6 баллов):**
    * Приложение разбито на независимые процессы (не threads, не fork от одного родителя в классическом смысле, каждый модуль — отдельный бинарник).
    * [cite_start]Используются механизмы синхронизации POSIX (семафоры) и разделяемая память[cite: 405, 406].
    * Предусмотрено корректное завершение и очистка ресурсов (`shm_unlink`, `sem_unlink` в init-модуле).

2.  **Именованные семафоры и независимый запуск (7-8 баллов):**
    * [cite_start]Используются именованные семафоры (`/gallery_sem`, `/gallery_mutex` и т.д.), что позволяет запускать `gallery_visitor` и `gallery_guard` в разных терминалах независимо друг от друга[cite: 412, 414].
    * [cite_start]Каждый процесс выводит информацию в свою консоль (или общий поток при запуске скриптом)[cite: 418].

3.  **Монитор (9 баллов):**
    * [cite_start]Реализован отдельный процесс `gallery_monitor`, который работает независимо от симуляции и отображает ход событий[cite: 421].
    * *Примечание:* Обмен данными с монитором организован через общий кольцевой буфер в разделяемой памяти. Это обеспечивает высокую скорость и персистентность данных (монитор может подключиться в середине работы и прочитать историю).

4.  **Множественные наблюдатели (10 баллов):**
    * [cite_start]Архитектура приложения позволяет запускать **несколько экземпляров `gallery_monitor` одновременно**[cite: 428].
    * Это достигнуто благодаря тому, что каждый монитор хранит свой локальный индекс прочитанных сообщений (`last`), а общий индекс записи (`log_tail`) лежит в разделяемой памяти.
    * [cite_start]Один монитор не "крадет" сообщения у другого — они работают согласованно и выводят идентичную информацию в свои терминалы[cite: 432].
